name: Deploy to Hostinger

on:
  push:
    branches:
      - main

jobs:
  web-deploy:
    name: ğŸ‰ Deploy
    runs-on: ubuntu-latest
    steps:
      # 1. PEGAR O CÃ“DIGO
      - name: ğŸšš Get latest code
        uses: actions/checkout@v4

      # 2. INSTALAR NODE
      - name: ğŸŸ¢ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. INSTALAR DEPENDÃŠNCIAS
      - name: ğŸ“¦ Install Dependencies
        run: npm install

      # 4. CONSTRUIR O SITE
      - name: ğŸ—ï¸ Build Site
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}

      # 5. PREPARAR PASTA PARA ENVIO
      - name: ğŸ—‚ï¸ Prepare Dist Folder
        run: |
          mkdir dist
          cp -r out/* dist/
          cp backend/*.php dist/
          mkdir -p dist/admin
          cp backend/admin/*.php dist/admin/
          mkdir -p dist/uploads

      # 6. UPLOAD VIA LFTP (MÃ‰TODO ROBUSTO)
      # Instala o lftp e manda os arquivos sem choro
      - name: ğŸš€ Upload via LFTP
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp
          lftp -e "set ssl:verify-certificate no; open ${{ secrets.FTP_SERVER }}; user ${{ secrets.FTP_USERNAME }} ${{ secrets.FTP_PASSWORD }}; mirror -R --verbose --parallel=2 --no-delete ./dist ./test; bye"